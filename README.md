# Mnemosyne é•¿æœŸè®°å¿†æ’ä»¶

AstrBot çš„é•¿æœŸè®°å¿†ç®¡ç†æ’ä»¶ï¼ŒåŸºäº Milvus å‘é‡æ•°æ®åº“å®ç°å¯¹è¯è®°å¿†çš„å­˜å‚¨ã€æ£€ç´¢å’Œæ€»ç»“åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ§  **æ™ºèƒ½è®°å¿†æ€»ç»“**ï¼šè‡ªåŠ¨æ€»ç»“å¯¹è¯å†…å®¹å¹¶å­˜å‚¨ä¸ºé•¿æœŸè®°å¿†
- ğŸ” **ç›¸å…³è®°å¿†æ£€ç´¢**ï¼šåŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦æ£€ç´¢å†å²å¯¹è¯è®°å¿†
- ğŸ“Š **WebUI ç®¡ç†ç•Œé¢**ï¼šæä¾›å¯è§†åŒ–çš„è®°å¿†ç®¡ç†å’Œé…ç½®ç•Œé¢
- ğŸ—‚ï¸ **è®°å¿†é›†åˆç®¡ç†**ï¼šæ”¯æŒå¤šä¸ªç‹¬ç«‹çš„è®°å¿†é›†åˆï¼Œéš”ç¦»ä¸åŒåœºæ™¯çš„è®°å¿†
- ğŸ”„ **è‡ªåŠ¨æ•°æ®è¿ç§»**ï¼šæ”¯æŒä»æ—§ç‰ˆæœ¬æ•°æ®æ ¼å¼è‡ªåŠ¨è¿ç§»

## ç³»ç»Ÿè¦æ±‚

### å¿…éœ€ä¾èµ–

- Python 3.9+
- AstrBot 4.0+
- Milvus å‘é‡æ•°æ®åº“ï¼ˆæ¨è 2.3.0+ï¼‰

### Python ä¾èµ–åŒ…

```bash
pymilvus>=2.3.0
pydantic>=2.0.0
```

## å®‰è£…æ­¥éª¤

### 1. å®‰è£… Milvus

**ä½¿ç”¨ Dockerï¼ˆæ¨èï¼‰**ï¼š

```bash
# ä¸‹è½½ Milvus Standalone docker-compose é…ç½®
wget https://github.com/milvus-io/milvus/releases/download/v2.3.0/milvus-standalone-docker-compose.yml -O docker-compose.yml

# å¯åŠ¨ Milvus
docker-compose up -d
```

**ä½¿ç”¨ Milvus Liteï¼ˆè½»é‡çº§ï¼‰**ï¼š

```bash
pip install milvus
```

æ›´å¤šå®‰è£…æ–¹å¼è¯·å‚è€ƒï¼šhttps://milvus.io/docs/install_standalone-docker.md

### 2. å®‰è£…æ’ä»¶

1. ä¸‹è½½æ’ä»¶åˆ° AstrBot çš„ `data/plugins` ç›®å½•ï¼š
   ```bash
   cd data/plugins
   git clone <repository-url> astrbot_plugin_mnemosyne
   ```

2. å®‰è£…ä¾èµ–ï¼š
   ```bash
   pip install pymilvus>=2.3.0 pydantic>=2.0.0
   ```

3. é‡å¯ AstrBot

## é…ç½®è¯´æ˜

### åŸºç¡€é…ç½®

| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ | èŒƒå›´ |
|--------|------|--------|------|
| `milvus_host` | Milvus æœåŠ¡å™¨åœ°å€ | `127.0.0.1` | - |
| `milvus_port` | Milvus æœåŠ¡å™¨ç«¯å£ | `19530` | 1-65535 |
| `collection_name` | Milvus é›†åˆåç§° | `default` | - |
| `num_pairs` | è®°å¿†æ€»ç»“çš„å¯¹è¯è½®æ•° | `5` | 1-25 |

**é‡è¦è¯´æ˜**ï¼š
- `num_pairs` é…ç½®ä¸º**å¯¹è¯è½®æ•°**ï¼Œä¸€é—®ä¸€ç­”ç®—ä½œ 1 è½®å¯¹è¯
- ä¾‹å¦‚è®¾ç½®ä¸º 5ï¼Œè¡¨ç¤ºæ¯ 5 è½®å¯¹è¯ï¼ˆ5 æ¬¡é—®ç­”ï¼‰åè¿›è¡Œè®°å¿†æ€»ç»“

### é«˜çº§é…ç½®

| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ | èŒƒå›´ |
|--------|------|--------|------|
| `embedding_dim` | å‘é‡ç»´åº¦ï¼ˆè‡ªåŠ¨è·å–ï¼‰ | `1536` | 128-4096 |
| `index_type` | ç´¢å¼•ç±»å‹ | `IVF_FLAT` | - |
| `metric_type` | è·ç¦»åº¦é‡ç±»å‹ | `COSINE` | `COSINE`/`L2`/`IP` |
| `nlist` | IVF ç´¢å¼•èšç±»ä¸­å¿ƒæ•° | `128` | 1-65536 |
| `nprobe` | æŸ¥è¯¢æ—¶æ¢æµ‹çš„èšç±»æ•° | `16` | 1-nlist |
| `top_k` | æ£€ç´¢è¿”å›çš„æœ€å¤§è®°å¿†æ•° | `5` | 1-20 |
| `score_threshold` | ç›¸ä¼¼åº¦é˜ˆå€¼ | `0.7` | 0.0-1.0 |

**æ³¨æ„äº‹é¡¹**ï¼š
- `embedding_dim` ä¼šè‡ªåŠ¨ä» AstrBot çš„ `embedding_provider` è·å–ï¼Œé€šå¸¸æ— éœ€æ‰‹åŠ¨é…ç½®
- å¦‚æœ Provider æœªå°±ç»ªï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼ 1536ï¼ˆOpenAI text-embedding-ada-002 ç»´åº¦ï¼‰

### é…ç½®æ–‡ä»¶ç¤ºä¾‹

```json
{
  "milvus_host": "127.0.0.1",
  "milvus_port": 19530,
  "collection_name": "default",
  "num_pairs": 5,
  "top_k": 5,
  "score_threshold": 0.7,
  "index_type": "IVF_FLAT",
  "metric_type": "COSINE",
  "nlist": 128,
  "nprobe": 16
}
```

## ä½¿ç”¨æŒ‡å—

### 1. WebUI ç®¡ç†ç•Œé¢

æ’ä»¶æä¾›äº†å®Œæ•´çš„ WebUI ç®¡ç†ç•Œé¢ï¼Œè¯¦ç»†æ–‡æ¡£è¯·å‚è€ƒï¼š[admin_panel/README.md](admin_panel/README.md)

ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š
- ğŸ“‹ è®°å¿†åˆ—è¡¨æŸ¥çœ‹å’Œæœç´¢
- â• æ‰‹åŠ¨æ·»åŠ è®°å¿†
- âœï¸ ç¼–è¾‘å’Œåˆ é™¤è®°å¿†
- ğŸ” è®°å¿†æ£€ç´¢æµ‹è¯•
- âš™ï¸ å®æ—¶é…ç½®ç®¡ç†

è®¿é—®æ–¹å¼ï¼šAstrBot Dashboard â†’ æ’ä»¶ç®¡ç† â†’ Mnemosyne â†’ ç®¡ç†é¢æ¿

### 2. å‘½ä»¤è¡Œä½¿ç”¨

**æŸ¥çœ‹è®°å¿†ç»Ÿè®¡**ï¼š
```
/mne stats
```

**æ‰‹åŠ¨è§¦å‘æ€»ç»“**ï¼š
```
/mne summarize
```

**æœç´¢è®°å¿†**ï¼š
```
/mne search <å…³é”®è¯>
```

## å·¥ä½œåŸç†

### è®°å¿†æ€»ç»“æµç¨‹

```
ç”¨æˆ·å¯¹è¯ â†’ æ¶ˆæ¯è®¡æ•° â†’ è¾¾åˆ°é˜ˆå€¼ â†’ è°ƒç”¨ LLM æ€»ç»“ â†’ ç”Ÿæˆå‘é‡ â†’ å­˜å‚¨åˆ° Milvus
```

1. **æ¶ˆæ¯è®¡æ•°**ï¼šæ¯æ¬¡å¯¹è¯åï¼Œæ’ä»¶ä¼šè·Ÿè¸ªæ¶ˆæ¯æ•°é‡
2. **è§¦å‘æ€»ç»“**ï¼šå½“ç´¯è®¡è¾¾åˆ° `num_pairs * 2` æ¡æ¶ˆæ¯æ—¶è§¦å‘æ€»ç»“
3. **LLM æ€»ç»“**ï¼šè°ƒç”¨ AstrBot çš„ LLM æä¾›è€…ç”Ÿæˆæ‘˜è¦
4. **å‘é‡åŒ–**ï¼šä½¿ç”¨ Embedding Provider å°†æ‘˜è¦è½¬æ¢ä¸ºå‘é‡
5. **å­˜å‚¨**ï¼šå°†å‘é‡å’Œå…ƒæ•°æ®å­˜å‚¨åˆ° Milvus é›†åˆ

### è®°å¿†æ£€ç´¢æµç¨‹

```
ç”¨æˆ·æ¶ˆæ¯ â†’ å‘é‡åŒ– â†’ Milvus æ£€ç´¢ â†’ ç›¸ä¼¼åº¦è¿‡æ»¤ â†’ è¿”å›ç›¸å…³è®°å¿†
```

1. **å‘é‡åŒ–æŸ¥è¯¢**ï¼šå°†ç”¨æˆ·æ¶ˆæ¯è½¬æ¢ä¸ºå‘é‡
2. **è¯­ä¹‰æ£€ç´¢**ï¼šåœ¨ Milvus ä¸­æ‰§è¡Œ ANNï¼ˆè¿‘ä¼¼æœ€è¿‘é‚»ï¼‰æœç´¢
3. **ç›¸ä¼¼åº¦è¿‡æ»¤**ï¼šåªè¿”å›ç›¸ä¼¼åº¦ â‰¥ `score_threshold` çš„è®°å¿†
4. **ä¸Šä¸‹æ–‡æ³¨å…¥**ï¼šå°†ç›¸å…³è®°å¿†æ³¨å…¥åˆ° LLM çš„ä¸Šä¸‹æ–‡ä¸­

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. Milvus è¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
[ERROR] æ— æ³•è¿æ¥åˆ° Milvus æœåŠ¡å™¨
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ Milvus æœåŠ¡æ˜¯å¦è¿è¡Œï¼š`docker ps | grep milvus`
- éªŒè¯ `milvus_host` å’Œ `milvus_port` é…ç½®
- æ£€æŸ¥é˜²ç«å¢™å’Œç½‘ç»œè¿æ¥

#### 2. Collection not loaded é”™è¯¯ï¼ˆå·²ä¿®å¤ï¼‰

**é”™è¯¯ä¿¡æ¯**ï¼š
```
MilvusException: (code=101, message=collection not loaded)
```

**ä¿®å¤è¯´æ˜**ï¼š
- æ’ä»¶ç°å·²é‡‡ç”¨**å»¶è¿ŸåŠ è½½ç­–ç•¥**
- é›†åˆä¼šåœ¨é¦–æ¬¡æŸ¥è¯¢æˆ–æ’å…¥æ—¶è‡ªåŠ¨åŠ è½½
- ä¸å†éœ€è¦æ‰‹åŠ¨å¤„ç†é›†åˆåŠ è½½é—®é¢˜

è¯¦ç»†ä¿®å¤ä¿¡æ¯è¯·å‚è€ƒï¼š[MILVUS_FIX_SUMMARY.md](MILVUS_FIX_SUMMARY.md)

#### 3. Embedding ç»´åº¦ä¸åŒ¹é…

**é”™è¯¯ä¿¡æ¯**ï¼š
```
[ERROR] Embedding ç»´åº¦ä¸åŒ¹é…
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ `embedding_provider` é…ç½®æ˜¯å¦æ­£ç¡®
- ç¡®ä¿æ‰€æœ‰æ¶ˆæ¯ä½¿ç”¨ç›¸åŒçš„ Embedding æ¨¡å‹
- å¦‚æœæ›´æ¢äº†æ¨¡å‹ï¼Œéœ€è¦é‡å»ºé›†åˆï¼š
  ```python
  # åˆ é™¤æ—§é›†åˆ
  collection.drop()
  # é‡å¯æ’ä»¶ä»¥åˆ›å»ºæ–°é›†åˆ
  ```

#### 4. è®°å¿†æ€»ç»“æœªè§¦å‘

**å¯èƒ½åŸå› **ï¼š
- å¯¹è¯è½®æ•°æœªè¾¾åˆ° `num_pairs` é˜ˆå€¼
- LLM Provider æœªæ­£ç¡®é…ç½®
- æ¶ˆæ¯è®¡æ•°å™¨è¢«é‡ç½®ï¼ˆé‡å¯ AstrBotï¼‰

**æ£€æŸ¥æ–¹æ³•**ï¼š
- æŸ¥çœ‹æ—¥å¿—ä¸­çš„æ¶ˆæ¯è®¡æ•°ä¿¡æ¯
- ä½¿ç”¨ `/mne stats` æŸ¥çœ‹å½“å‰ä¼šè¯çŠ¶æ€
- é™ä½ `num_pairs` å€¼è¿›è¡Œæµ‹è¯•

### è°ƒè¯•æ¨¡å¼

å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š

```python
# åœ¨ main.py ä¸­è®¾ç½®
import logging
logging.getLogger("astrbot_plugin_mnemosyne").setLevel(logging.DEBUG)
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ç´¢å¼•ä¼˜åŒ–

**å°æ•°æ®é›†ï¼ˆ< 1ä¸‡æ¡ï¼‰**ï¼š
```json
{
  "index_type": "FLAT",
  "nlist": 128
}
```

**ä¸­ç­‰æ•°æ®é›†ï¼ˆ1ä¸‡-10ä¸‡ï¼‰**ï¼š
```json
{
  "index_type": "IVF_FLAT",
  "nlist": 1024,
  "nprobe": 32
}
```

**å¤§æ•°æ®é›†ï¼ˆ> 10ä¸‡ï¼‰**ï¼š
```json
{
  "index_type": "IVF_PQ",
  "nlist": 2048,
  "nprobe": 64,
  "m": 8
}
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

- **è°ƒæ•´ `top_k`**ï¼šå‡å°‘è¿”å›çš„è®°å¿†æ•°é‡å¯æå‡é€Ÿåº¦
- **æé«˜ `score_threshold`**ï¼šè¿‡æ»¤æ‰ä½ç›¸å…³åº¦ç»“æœ
- **å‡å°‘ `nprobe`**ï¼šé™ä½æŸ¥è¯¢ç²¾åº¦ä½†æé«˜é€Ÿåº¦

### 3. èµ„æºç®¡ç†

- å®šæœŸæ¸…ç†æ— ç”¨è®°å¿†ï¼šä½¿ç”¨ WebUI åˆ é™¤è¿‡æ—¶æ•°æ®
- ä½¿ç”¨å¤šä¸ªé›†åˆéš”ç¦»ä¸åŒåœºæ™¯ï¼šé¿å…å•ä¸ªé›†åˆè¿‡å¤§
- ç›‘æ§ Milvus å†…å­˜ä½¿ç”¨ï¼šåŠæ—¶è°ƒæ•´ `replica_number`

## æ•°æ®å¤‡ä»½ä¸è¿ç§»

### å¤‡ä»½æ•°æ®

```bash
# å¯¼å‡º Milvus æ•°æ®
docker exec -it milvus-standalone bash
cd /var/lib/milvus/
tar -czf backup.tar.gz ./*
```

### æ¢å¤æ•°æ®

```bash
# åœæ­¢ Milvus
docker-compose down

# æ¢å¤æ•°æ®
docker exec -it milvus-standalone bash
cd /var/lib/milvus/
tar -xzf backup.tar.gz

# é‡å¯ Milvus
docker-compose up -d
```

### è¿ç§»åˆ°æ–°é›†åˆ

ä½¿ç”¨ WebUI çš„å¯¼å‡º/å¯¼å…¥åŠŸèƒ½ï¼Œæˆ–ä½¿ç”¨ Python è„šæœ¬ï¼š

```python
from pymilvus import Collection, connections

# è¿æ¥
connections.connect(host="127.0.0.1", port="19530")

# è¯»å–æ—§é›†åˆ
old_collection = Collection("old_collection")
old_collection.load()
results = old_collection.query(expr="id >= 0", output_fields=["*"])

# æ’å…¥åˆ°æ–°é›†åˆ
new_collection = Collection("new_collection")
new_collection.insert(results)
new_collection.flush()
```

## å¼€å‘æ–‡æ¡£

### ç›®å½•ç»“æ„

```
astrbot_plugin_mnemosyne/
â”œâ”€â”€ main.py                 # æ’ä»¶å…¥å£
â”œâ”€â”€ _conf_schema.json       # é…ç½®æ¨¡å¼
â”œâ”€â”€ admin_panel/           # WebUI ç®¡ç†ç•Œé¢
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ app.js
â”‚   â””â”€â”€ README.md
â”œâ”€â”€ core/                  # æ ¸å¿ƒé€»è¾‘
â”‚   â”œâ”€â”€ initialization.py  # åˆå§‹åŒ–
â”‚   â”œâ”€â”€ memory_operations.py  # è®°å¿†æ“ä½œ
â”‚   â””â”€â”€ context_utils.py   # ä¸Šä¸‹æ–‡å·¥å…·
â”œâ”€â”€ memory_manager/        # è®°å¿†ç®¡ç†
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ vector_db/
â”‚       â””â”€â”€ milvus_manager.py  # Milvus ç®¡ç†å™¨
â””â”€â”€ utils/                 # å·¥å…·å‡½æ•°
    â”œâ”€â”€ message_counter.py  # æ¶ˆæ¯è®¡æ•°
    â””â”€â”€ data_models.py     # æ•°æ®æ¨¡å‹
```

### API æ¥å£

æ’ä»¶æä¾›ä»¥ä¸‹ HTTP APIï¼š

- `GET /api/memories` - è·å–è®°å¿†åˆ—è¡¨
- `POST /api/memories` - åˆ›å»ºæ–°è®°å¿†
- `PUT /api/memories/{id}` - æ›´æ–°è®°å¿†
- `DELETE /api/memories/{id}` - åˆ é™¤è®°å¿†
- `POST /api/search` - æœç´¢è®°å¿†
- `GET /api/config` - è·å–é…ç½®
- `PUT /api/config` - æ›´æ–°é…ç½®

è¯¦ç»† API æ–‡æ¡£è¯·å‚è€ƒï¼š[admin_panel/README.md](admin_panel/README.md#api-æ¥å£)

## æ›´æ–°æ—¥å¿—

### v2.0.0 (2025-11-05)

**é‡å¤§æ”¹è¿›**ï¼š
- âœ… ä¿®å¤ Milvus "collection not loaded" é”™è¯¯
- âœ… å®ç°å»¶è¿ŸåŠ è½½ç­–ç•¥ï¼Œæå‡å¯åŠ¨é€Ÿåº¦
- âœ… ä¼˜åŒ– `num_pairs` é…ç½®é€»è¾‘ï¼ˆæ”¹ä¸ºå¯¹è¯è½®æ•°ï¼‰
- âœ… `embedding_dim` è‡ªåŠ¨è·å–ï¼Œç®€åŒ–é…ç½®
- âœ… å¢å¼ºé”™è¯¯å¤„ç†å’Œè¯Šæ–­ä¿¡æ¯
- âœ… å®Œå–„ WebUI ç®¡ç†ç•Œé¢
- âœ… æ–°å¢å®Œæ•´çš„æ–‡æ¡£å’Œæ•…éšœæ’æŸ¥æŒ‡å—

**ç ´åæ€§å˜æ›´**ï¼š
- `num_pairs` ç°åœ¨è¡¨ç¤ºå¯¹è¯è½®æ•°è€Œéæ¶ˆæ¯æ¡æ•°ï¼ˆæ—§ç‰ˆæœ¬éœ€è¦é™¤ä»¥ 2ï¼‰

### v1.x

- åˆå§‹ç‰ˆæœ¬åŠŸèƒ½å®ç°

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ä¸ AstrBot ç›¸åŒçš„è®¸å¯è¯ã€‚

## æ”¯æŒä¸åé¦ˆ

- é—®é¢˜æŠ¥å‘Šï¼šè¯·åœ¨ GitHub Issues ä¸­æäº¤
- åŠŸèƒ½å»ºè®®ï¼šæ¬¢è¿æäº¤ Pull Request
- 