# 🎛️ Mnemosyne Admin Panel - Web 管理面板完整文档

## 📋 目录

- [概述](#概述)
- [功能特性](#功能特性)
- [安装与配置](#安装与配置)
- [使用指南](#使用指南)
- [API 文档](#api-文档)
- [安全说明](#安全说明)
- [故障排除](#故障排除)

---

## 📖 概述

Mnemosyne Admin Panel 是一个功能强大的 Web 管理界面，为 Mnemosyne 长期记忆插件提供全方位的可视化管理能力。通过直观的 Web 界面，您可以轻松监控系统状态、管理记忆数据、查看日志和调整配置。

### 核心优势

- 🎨 **现代化界面**: 基于 Bootstrap 5 的响应式设计
- 📊 **实时监控**: 系统健康状态和性能指标实时更新
- 🧠 **智能管理**: 强大的记忆搜索、过滤和批量操作
- 📈 **数据可视化**: Chart.js 驱动的统计图表
- 🔒 **安全可靠**: API 密钥认证保护敏感操作

---

## ✨ 功能特性

### 1. 📊 系统监控仪表板

#### 健康状态监控
- **Milvus 连接状态**: 实时显示向量数据库连接状态
- **Embedding API 状态**: 监控嵌入向量生成服务
- **消息计数器状态**: 追踪会话消息统计服务
- **后台任务状态**: 监控自动总结任务运行情况

#### 性能指标
- **API 延迟**: P50/P95/P99 百分位延迟统计
- **成功率**: API 调用成功率追踪
- **吞吐量**: 每秒处理请求数（QPS）

#### 资源使用
- **内存占用**: 插件内存使用情况
- **数据库大小**: Milvus 数据存储容量
- **活跃会话数**: 当前活跃对话会话统计
- **记忆总数**: 存储的长期记忆条目总数

**API 端点:**
- `GET /api/system/status` - 获取系统状态
- `GET /api/system/performance` - 获取性能指标
- `GET /api/system/resources` - 获取资源使用情况

---

### 2. 🧠 记忆管理

#### 智能搜索
支持多维度记忆搜索：

- **关键词搜索**: 在记忆内容中进行全文搜索
- **会话过滤**: 按会话 ID 筛选特定对话的记忆
- **日期范围**: 按创建时间范围查询
- **人格过滤**: 按关联的 AI 人格 ID 筛选
- **分页浏览**: 支持大量数据的分页显示

#### 记忆操作
- **查看详情**: 展示记忆的完整信息
- **单条删除**: 删除指定的记忆条目
- **批量删除**: 删除会话的所有记忆
- **数据导出**: 导出为 JSON 或 CSV 格式

#### 统计分析
- **记忆增长趋势**: 可视化展示记忆数量变化
- **会话活跃度**: 各会话的记忆数量分布
- **日期分布**: 按日期统计记忆创建情况
- **平均长度**: 记忆内容的平均字符长度

**API 端点:**
- `POST /api/memories/search` - 搜索记忆
- `GET /api/memories/statistics` - 获取统计信息
- `GET /api/memories/sessions` - 获取会话列表
- `DELETE /api/memories/{memory_id}` - 删除单条记忆
- `DELETE /api/memories/session/{session_id}` - 删除会话记忆
- `POST /api/memories/export` - 导出记忆数据

---

### 3. 👥 会话管理

#### 会话列表
- **会话 ID**: 唯一标识每个对话会话
- **记忆数量**: 该会话下的记忆条目数
- **首次创建时间**: 该会话的第一条记忆时间
- **最后活跃时间**: 该会话的最新记忆时间

#### 会话操作
- **查看记忆**: 快速跳转到该会话的所有记忆
- **删除会话**: 清除会话及其所有关联记忆
- **导出会话**: 导出特定会话的记忆数据

---

### 4. 📋 日志查看器

#### 实时日志流
- **自动刷新**: 可配置的自动刷新间隔（5/10/30秒）
- **日志级别**: 按 DEBUG/INFO/WARNING/ERROR 筛选
- **关键词过滤**: 搜索包含特定内容的日志
- **时间排序**: 按时间倒序显示最新日志

#### 日志导出
- **格式支持**: 纯文本或 JSON 格式
- **时间范围**: 指定起止时间导出
- **批量导出**: 一次性导出大量日志记录

**API 端点:**
- `GET /api/logs` - 获取日志列表
- `POST /api/logs/export` - 导出日志

---

### 5. ⚙️ 配置管理

#### 配置分类
- **Milvus 配置**: 数据库连接、集合设置
- **Embedding 配置**: 嵌入向量服务设置
- **性能配置**: 缓存、超时等性能参数
- **功能配置**: 自动总结、消息计数等功能开关

#### 配置操作
- **可视化编辑**: 友好的表单界面
- **实时验证**: 保存前验证配置有效性
- **配置备份**: 导出当前配置为 JSON
- **配置恢复**: 从备份文件恢复配置

**API 端点:**
- `GET /api/config` - 获取当前配置
- `POST /api/config` - 更新配置
- `POST /api/config/backup` - 导出配置
- `POST /api/config/restore` - 恢复配置

---

## 🚀 安装与配置

### 前置要求

- Python 3.8+
- AstrBot 主程序
- Mnemosyne 插件 v0.5.2+
- 所需 Python 包（自动安装）:
  ```
  fastapi>=0.104.0
  uvicorn>=0.24.0
  jinja2>=3.1.2
  python-multipart>=0.0.6
  ```

### 自动安装

Admin Panel 随 Mnemosyne 插件自动安装，无需额外配置。插件启动时会自动初始化管理面板服务器。

### 配置选项

在插件配置文件中添加或修改 `admin_panel` 部分：

```yaml
admin_panel:
  # 服务器端口（默认: 8000）
  port: 8000
  
  # 绑定地址（默认: 127.0.0.1）
  host: "127.0.0.1"
  
  # API 密钥（用于认证）
  # 如果未设置，系统会自动生成
  api_key: "your-secure-api-key-here"
  
  # 是否启用（默认: true）
  enabled: true
```

### 启动管理面板

管理面板会在插件加载时自动启动。您将在日志中看到类似信息：

```
[INFO] Admin Panel 服务器已启动在端口 8000
[INFO] 🔑 Admin Panel API 密钥: your-api-key
[INFO] 💡 请妥善保存此密钥
```

### 访问管理面板

1. 确保 Mnemosyne 插件正在运行
2. 在浏览器中访问: `http://127.0.0.1:8000`
3. 首次访问时，系统会要求输入 API 密钥
4. 输入配置的 API 密钥或启动时生成的密钥

---

## 📚 使用指南

### 首次使用

1. **启动插件**
   ```bash
   # 在 AstrBot 目录下
   python main.py
   ```

2. **查找 API 密钥**
   - 在启动日志中查找 API 密钥
   - 或在配置文件中查看 `admin_panel.api_key`

3. **访问管理面板**
   - 打开浏览器，访问 `http://127.0.0.1:8000`
   - 在首页输入 API 密钥进行认证

4. **探索功能**
   - 使用侧边栏导航切换不同功能模块
   - 查看系统状态和性能指标
   - 浏览和管理记忆数据

### 常见操作流程

#### 查看系统健康状态
1. 访问首页（Dashboard）
2. 查看"系统健康状态"卡片
3. 绿色图标表示正常，红色表示异常
4. 点击"查看详情"获取更多信息

#### 搜索特定记忆
1. 进入"记忆管理"页面
2. 在搜索框中输入关键词
3. 设置可选的过滤条件（会话ID、日期等）
4. 点击"搜索"按钮
5. 在结果中查看和操作记忆

#### 导出会话数据
1. 进入"会话管理"页面
2. 找到目标会话
3. 点击"导出"按钮
4. 选择导出格式（JSON/CSV）
5. 下载导出文件

#### 清理旧记忆
1. 进入"记忆管理"页面
2. 设置日期范围过滤（例如：3个月前）
3. 查看搜索结果
4. 选择需要删除的记忆
5. 确认删除操作

---

## 🔌 API 文档

### 认证方式

所有 API 请求（除公开路径外）都需要在 HTTP 头中包含 API 密钥：

```http
X-API-Key: your-api-key-here
```

### 响应格式

所有 API 响应都采用 JSON 格式：

**成功响应:**
```json
{
  "success": true,
  "data": { ... }
}
```

**错误响应:**
```json
{
  "success": false,
  "error": "错误描述"
}
```

### 核心 API 端点

#### 系统监控

**获取系统状态**
```http
GET /api/system/status
```

响应示例:
```json
{
  "success": true,
  "data": {
    "milvus_connected": true,
    "embedding_available": true,
    "message_counter_active": true,
    "background_task_running": true,
    "uptime_seconds": 3600
  }
}
```

**获取性能指标**
```http
GET /api/system/performance
```

**获取资源使用**
```http
GET /api/system/resources
```

#### 记忆管理

**搜索记忆**
```http
POST /api/memories/search
Content-Type: application/json

{
  "session_id": "optional-session-id",
  "keyword": "optional-keyword",
  "start_date": "2024-01-01T00:00:00",
  "end_date": "2024-12-31T23:59:59",
  "limit": 10,
  "offset": 0
}
```

**获取统计信息**
```http
GET /api/memories/statistics
```

**删除记忆**
```http
DELETE /api/memories/{memory_id}
```

**导出记忆**
```http
POST /api/memories/export?format=json&session_id=xxx
```

#### 会话管理

**获取会话列表**
```http
GET /api/memories/sessions?limit=100
```

**删除会话**
```http
DELETE /api/memories/session/{session_id}
```

#### 配置管理

**获取配置**
```http
GET /api/config
```

**更新配置**
```http
POST /api/config
Content-Type: application/json

{
  "key": "value"
}
```

### 错误代码

| 状态码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误 |
| 401 | 未授权（API 密钥无效） |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

---

## 🔒 安全说明

### 重要安全建议

⚠️ **请务必注意以下安全事项：**

1. **本地访问优先**
   - 默认绑定到 
127.0.0.1`，仅允许本地访问
   - 不要将管理面板暴露到公网
   - 如需远程访问，请使用 SSH 隧道或 VPN

2. **API 密钥保护**
   - 使用强密码作为 API 密钥
   - 定期更换 API 密钥
   - 不要在公共场合分享密钥
   - 将密钥存储在安全的位置

3. **网络安全**
   - 仅在受信任的网络环境中使用
   - 考虑使用防火墙限制访问
   - 启用 HTTPS（计划中的功能）

4. **数据备份**
   - 在执行批量删除前备份数据
   - 定期导出重要的记忆数据
   - 保存配置文件的备份

### 推荐的安全实践

**生产环境部署建议:**

```bash
# 使用 SSH 隧道安全访问远程服务器
ssh -L 8000:127.0.0.1:8000 user@remote-server

# 然后在本地浏览器访问
# http://localhost:8000
```

**强密码生成示例:**

```python
import secrets
api_key = secrets.token_urlsafe(32)
print(f"生成的 API 密钥: {api_key}")
```

---

## 🔧 故障排除

### 常见问题

#### 1. 无法访问管理面板

**症状:** 浏览器显示"无法连接"

**解决方案:**
- 确认插件已成功启动
- 检查端口是否被占用：`netstat -an | findstr 8000`
- 查看日志中是否有错误信息
- 尝试更换端口号

#### 2. API 密钥认证失败

**症状:** 提示"Unauthorized"或"Invalid API Key"

**解决方案:**
- 确认输入的 API 密钥正确
- 检查配置文件中的 `api_key` 设置
- 查看启动日志中自动生成的密钥
- 清除浏览器缓存和 Cookie

#### 3. Milvus 连接错误

**症状:** 系统状态显示 Milvus 未连接

**解决方案:**
- 检查 Milvus 服务是否运行
- 验证 Milvus 连接配置是否正确
- 查看 Milvus 服务日志
- 尝试重启 Milvus 服务

#### 4. 记忆搜索返回空结果

**症状:** 搜索记忆时没有结果

**解决方案:**
- 确认集合中确实有数据
- 检查搜索条件是否过于严格
- 验证集合是否已加载到内存
- 查看 Milvus 日志确认查询执行

#### 5. 性能问题

**症状:** 页面加载缓慢或超时

**解决方案:**
- 检查数据库连接延迟
- 减少单次查询的数据量
- 优化搜索条件和过滤器
- 考虑增加服务器资源

### 日志分析

**查看插件日志:**

```bash
# 在 AstrBot 日志目录中
tail -f logs/astrbot.log | grep "AdminPanel\|Mnemosyne"
```

**常见日志级别:**
- `[DEBUG]`: 调试信息，用于开发和故障排除
- `[INFO]`: 正常运行信息
- `[WARNING]`: 警告信息，不影响功能但需注意
- `[ERROR]`: 错误信息，可能影响功能
- `[CRITICAL]`: 严重错误，需要立即处理

### 获取帮助

如果遇到无法解决的问题：

1. **查看文档**: 仔细阅读相关功能的文档说明
2. **搜索 Issues**: 在 GitHub 仓库搜索类似问题
3. **提交 Issue**: 提供详细的错误信息和复现步骤
4. **加入社区**: 在 QQ 群中寻求帮助

**提交 Bug 报告时请包含:**
- 错误描述和复现步骤
- 相关日志片段
- 系统环境信息（OS、Python 版本等）
- 插件版本号

---

## 📊 性能优化建议

### 数据库优化

1. **索引优化**
   - 确保向量字段已创建索引
   - 使用合适的索引类型（HNSW、IVF_FLAT 等）
   - 定期维护索引

2. **查询优化**
   - 使用过滤条件减少扫描范围
   - 限制返回结果数量
   - 避免频繁的全表扫描

3. **集合管理**
   - 定期清理过期数据
   - 合理设置集合大小
   - 监控集合性能指标

### 前端优化

1. **减少请求频率**
   - 使用适当的自动刷新间隔
   - 启用分页加载
   - 实施请求节流

2. **缓存策略**
   - 缓存静态资源
   - 使用浏览器缓存
   - 实施数据缓存

---

## 🤝 贡献指南

欢迎为 Admin Panel 贡献代码！详细信息请参阅主项目的贡献指南。

---

## 📄 许可证

本项目遵循主项目许可证。详见 [LICENSE](../LICENSE)。

---

## 🙏 致谢

- **AstrBot 团队**: 提供强大的机器人框架
- **FastAPI**: 现代化的 Web 框架  
- **Bootstrap**: 优秀的前端 UI 框架
- **Chart.js**: 强大的图表库
- **所有贡献者**: 感谢每一位贡献者的付出

---

## 📞 联系方式

- **GitHub**: https://github.com/lxfight/astrbot_plugin_mnemosyne
- **QQ 群**: 953245617
- **Issues**: https://github.com/lxfight/astrbot_plugin_mnemosyne/issues

---

**最后更新**: 2024-11-05  
**文档版本**: v2.0.0